<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi MedicaciÃ³n</title>
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;padding:0}
        input,select,textarea{font-size:16px!important}
        .hide-scrollbar::-webkit-scrollbar{display:none}
        .hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        @keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        @keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes spin{to{transform:rotate(360deg)}}
        .animate-slideUp{animation:slideUp .3s ease-out}
        .animate-slideDown{animation:slideDown .3s ease-out}
        .animate-fadeIn{animation:fadeIn .3s ease-out}
        .animate-spin{animation:spin 1s linear infinite}
    </style>
</head>
<body class="bg-gray-100">
<div id="app"></div>
<script>
(function() {
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                    CONFIGURACIÃ“N - RELLENA ESTO DE NUEVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
    // 1. URL de tu proyecto Supabase
    SUPABASE_URL: 'TU_SUPABASE_URL_AQUI',
    
    // 2. Tu clave pÃºblica "anon"
    SUPABASE_KEY: 'TU_SUPABASE_KEY_AQUI',
    
    AVISO_MINUTOS: 5
};

// Variables globales
let sbClient = null;
let currentUser = null;

const state={screen:'splash',tab:'home',meds:[],history:[],modal:null,selMed:null,pendingOCR:[],toast:null,aiAdvice:null,histFilter:{type:'day',medId:null,date:new Date()},perms:{camera:false,notif:false},loading:false,loadingMsg:'Procesando...'};

// Utilidades
const U={
    time:(d=new Date())=>d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
    date:(d=new Date())=>d.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long'}),
    dateISO:(d=new Date())=>d.toISOString().split('T')[0],
    parseT:t=>{const[h,m]=t.split(':').map(Number);return h*60+m},
    toTime:m=>`${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`,
    nextDose:(from,freq)=>U.toTime((U.parseT(from)+freq*60)%(24*60)),
    genId:()=>Date.now().toString(36)+Math.random().toString(36).substr(2),
    toast:(msg,type='success')=>{state.toast={msg,type};render();setTimeout(()=>{state.toast=null;render()},3000)},
    takenToday:id=>state.history.some(h=>h.med_id===id&&h.fecha.startsWith(U.dateISO())&&h.estado==='tomado')
};

// Base de datos local
const DB={
    get:k=>{try{const d=localStorage.getItem('med_'+k);return d?JSON.parse(d):null}catch{return null}},
    set:(k,v)=>{try{localStorage.setItem('med_'+k,JSON.stringify(v))}catch(e){console.error('Error local:',e)}},
    load:()=>{state.meds=DB.get('meds')||[];state.history=DB.get('history')||[];currentUser=DB.get('user')},
    save:()=>{DB.set('meds',state.meds);DB.set('history',state.history);if(currentUser)DB.set('user',currentUser)}
};

// Supabase
const Cloud={
    async init(){
        if(!window.supabase){console.warn('Supabase off');return;}
        try{
            sbClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
            console.log('âœ… Supabase inicializado');
            const {data:{session}} = await sbClient.auth.getSession();
            if(session?.user){
                currentUser = {id: session.user.id, email: session.user.email};
                DB.set('user', currentUser);
                await Cloud.loadData();
            }
        }catch(e){console.error('Error init:',e)}
    },
    async login(email,pwd){
        if(!sbClient) return{error:{message:'Error conexiÃ³n'}};
        try{
            let{data,error}=await sbClient.auth.signInWithPassword({email,password:pwd});
            if(error && (error.message.includes('Invalid')||error.message.includes('not found'))){
                const res = await sbClient.auth.signUp({email,password:pwd});
                data=res.data; error=res.error;
                if(!error && data.user) U.toast('Cuenta creada','success');
            }
            if(!error && data.user){
                currentUser={id:data.user.id,email:data.user.email};
                DB.set('user',currentUser);
                await Cloud.loadData();
            }
            return{data,error}
        }catch(e){return{error:{message:e.message}}}
    },
    async loadData(){
        if(!sbClient||!currentUser||currentUser.id==='local') return;
        try{
            const{data:m}=await sbClient.from('medicamentos').select('*').eq('activo',true);
            const{data:h}=await sbClient.from('historial').select('*').order('created_at',{ascending:false}).limit(100);
            if(m) state.meds=m;
            if(h) state.history=h;
            DB.save();
        }catch(e){console.error('Sync error:',e)}
    },
    async saveMed(med){
        DB.save();
        if(!sbClient||!currentUser||currentUser.id==='local') return;
        try{await sbClient.from('medicamentos').upsert({...med, user_id:currentUser.id})}catch(e){}
    },
    async saveHist(e){
        DB.save();
        if(!sbClient||!currentUser||currentUser.id==='local') return;
        try{await sbClient.from('historial').insert({...e, user_id:currentUser.id})}catch(e){}
    },
    async logout(){
        try{if(sbClient)await sbClient.auth.signOut()}catch(e){}
        localStorage.clear(); location.reload();
    }
};

// IA con limpieza de JSON (VERSIÃ“N CORREGIDA)
const Gemini={
    async analyze(b64){
        if(!sbClient){U.toast('Sin conexiÃ³n','error');return[];}
        console.log('ğŸ“¡ Enviando a Supabase...');
        try{
            const { data, error } = await sbClient.functions.invoke('analizar-receta', {
                body: { image: b64 }
            });

            if(error) throw new Error(error.message);
            
            console.log('ğŸ“¥ Respuesta cruda:', data);
            
            // 1. Extraer texto
            let txt = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if(!txt) throw new Error('Respuesta vacÃ­a de la IA');

            // 2. Limpiar JSON (Buscar corchetes)
            const first = txt.indexOf('[');
            const last = txt.lastIndexOf(']');
            if(first !== -1 && last !== -1){
                txt = txt.substring(first, last+1);
            } else {
                throw new Error('No se encontraron medicamentos');
            }

            // 3. Parsear
            const json = JSON.parse(txt);
            
            // 4. Validar
            const meds = (Array.isArray(json)?json:[])
                .filter(m => m && m.nombre)
                .map(m => ({
                    nombre: String(m.nombre||'').trim(),
                    dosis: String(m.dosis||'SegÃºn pauta').trim(),
                    frecuencia: parseInt(m.frecuencia)||8,
                    dias: parseInt(m.dias)||0,
                    notas: String(m.notas||'').trim()
                }));

            if(meds.length===0) U.toast('No se leyeron medicamentos','warning');
            return meds;

        }catch(e){
            console.error(e);
            U.toast('Error al leer receta','error');
            return [];
        }
    },
    async advice(ctx,action){
        return {skip:'Saltado',late:'Tarde',edit:'Editado'}[action]||'';
    }
};

// Notificaciones
const Notif={
    async request(){
        if(!('Notification'in window)){U.toast('No soportado','error');return}
        const p=await Notification.requestPermission();
        state.perms.notif=p==='granted';
        if(state.perms.notif){Notif.schedule();U.toast('âœ… Avisos activados')}
        render();
    },
    schedule(){setInterval(Notif.check,60000);Notif.check()},
    check(){
        if(!state.perms.notif)return;
        const now=U.parseT(U.time());
        state.meds.forEach(m=>{
            if(!m.activo)return;
            const t=U.parseT(m.proxima_toma),diff=t-now;
            if(diff===CONFIG.AVISO_MINUTOS)Notif.send(`â° ${m.nombre} en ${CONFIG.AVISO_MINUTOS} min`,m.dosis);
            if(diff===0)Notif.send(`ğŸ’Š Â¡Hora de ${m.nombre}!`,`Toma ${m.dosis} ahora`)
        })
    },
    send:(title,body)=>{
        if(Notification.permission==='granted')new Notification(title,{body,icon:'https://cdn-icons-png.flaticon.com/512/3063/3063176.png',tag:'med'})
    }
};

// CÃ¡mara
const Cam={
    async capture(){
        return new Promise(res=>{
            const inp=document.createElement('input');
            inp.type='file'; inp.accept='image/*'; inp.capture='environment';
            inp.onchange=e=>{const f=e.target.files[0];const r=new FileReader();r.onload=()=>res(r.result?.split(',')[1]);if(f)r.readAsDataURL(f);else res(null)};
            inp.click()
        })
    },
    async select(){
        return new Promise(res=>{
            const inp=document.createElement('input');
            inp.type='file'; inp.accept='image/*';
            inp.onchange=e=>{const f=e.target.files[0];const r=new FileReader();r.onload=()=>res(r.result?.split(',')[1]);if(f)r.readAsDataURL(f);else res(null)};
            inp.click()
        })
    }
};

// Acciones
const Act={
    take(med,time=null){
        const hr=time||U.time(),prox=U.nextDose(hr,med.frecuencia);
        const i=state.meds.findIndex(m=>m.id===med.id);
        if(i!==-1){state.meds[i].proxima_toma=prox;Cloud.saveMed(state.meds[i])}
        const e={id:U.genId(),med_id:med.id,nombre:med.nombre,hora_programada:med.proxima_toma,hora_real:hr,estado:'tomado',proxima_recalculada:prox,fecha:new Date().toISOString(),created_at:new Date().toISOString()};
        state.history.unshift(e);Cloud.saveHist(e);
        state.modal=null;U.toast(`âœ… ${med.nombre} registrado`);render()
    },
    skip(med){
        const prox=U.nextDose(U.time(),med.frecuencia);
        const i=state.meds.findIndex(m=>m.id===med.id);
        if(i!==-1){state.meds[i].proxima_toma=prox;Cloud.saveMed(state.meds[i])}
        const e={id:U.genId(),med_id:med.id,nombre:med.nombre,hora_programada:med.proxima_toma,hora_real:'-',estado:'saltado',proxima_recalculada:prox,fecha:new Date().toISOString(),created_at:new Date().toISOString()};
        state.history.unshift(e);Cloud.saveHist(e);
        state.modal=null;render()
    },
    postpone(med,mins){
        const nt=U.toTime(U.parseT(U.time())+mins);
        const i=state.meds.findIndex(m=>m.id===med.id);
        if(i!==-1){state.meds[i].proxima_toma=nt;Cloud.saveMed(state.meds[i])}
        state.modal=null;U.toast(`â° Postergado a las ${nt}`);render()
    },
    add(m){
        const nm={id:U.genId(),nombre:m.nombre,dosis:m.dosis,frecuencia:m.frecuencia||8,hora_inicio:m.horaInicio||'08:00',proxima_toma:U.nextDose(m.horaInicio||'08:00',m.frecuencia||8),dias:m.dias||0,notas:m.notas||'',activo:true,fecha_inicio:U.dateISO(),color:['bg-purple-500','bg-blue-500','bg-green-500','bg-orange-500','bg-pink-500','bg-cyan-500'][state.meds.length%6]};
        state.meds.push(nm);Cloud.saveMed(nm);return nm
    },
    update(id,upd){
        const i=state.meds.findIndex(m=>m.id===id);if(i===-1)return;
        const old={...state.meds[i]};state.meds[i]={...old,...upd};
        if(upd.frecuencia&&upd.frecuencia!==old.frecuencia)state.meds[i].proxima_toma=U.nextDose(upd.hora_inicio||old.hora_inicio,upd.frecuencia);
        Cloud.saveMed(state.meds[i]);state.modal=null;U.toast('âœ… Actualizado');render()
    },
    del(id){
        if(!confirm('Â¿Eliminar?'))return;
        const i=state.meds.findIndex(m=>m.id===id);
        if(i!==-1){state.meds[i].activo=false;Cloud.saveMed(state.meds[i])}
        state.meds=state.meds.filter(m=>m.activo!==false);DB.save();
        state.modal=null;render()
    },
    async ocr(b64){
        state.loading=true;state.loadingMsg='ğŸ” Analizando...';render();
        const ms=await Gemini.analyze(b64);
        state.loading=false;
        if(ms.length>0){state.pendingOCR=ms.map((m,i)=>({...m,checked:true,id:i}));state.modal='ocr-results'}
        render();
    },
    confirmOCR(){
        state.pendingOCR.filter(m=>m.checked).forEach(m=>Act.add(m));
        state.pendingOCR=[];state.modal=null;U.toast('âœ… Medicamentos aÃ±adidos');render()
    },
    filteredHist(){
        let f=[...state.history];const fl=state.histFilter;
        if(fl.medId)f=f.filter(h=>h.med_id===fl.medId);
        if(fl.type==='day'){const d=U.dateISO(fl.date);f=f.filter(h=>h.fecha.startsWith(d))}
        else if(fl.type==='week'){const ws=new Date(fl.date);ws.setDate(ws.getDate()-ws.getDay());const we=new Date(ws);we.setDate(we.getDate()+7);f=f.filter(h=>{const d=new Date(h.fecha);return d>=ws&&d<we})}
        return f
    }
};

// UI Handlers
window.setTab=t=>{state.tab=t;render()};
window.openModal=(m,id=null)=>{state.modal=m;state.selMed=id?state.meds.find(x=>x.id===id):null;render()};
window.closeModal=()=>{state.modal=null;state.selMed=null;state.pendingOCR=[];render()};
window.closeAI=()=>{state.aiAdvice=null;render()};
window.takeMed=(id,t)=>Act.take(state.meds.find(x=>x.id===id),t);
window.skipMed=id=>Act.skip(state.meds.find(x=>x.id===id));
window.delMed=id=>Act.del(id);
window.toggleOCR=id=>{const i=state.pendingOCR.findIndex(m=>m.id===id);if(i!==-1){state.pendingOCR[i].checked=!state.pendingOCR[i].checked;render()}};
window.confirmOCR=()=>Act.confirmOCR();
window.scanRecipe=async()=>{const b=await Cam.select();if(b)Act.ocr(b)};
window.captureRecipe=async()=>{const b=await Cam.capture();if(b)Act.ocr(b)};
window.setHistFilter=t=>{state.histFilter.type=t;render()};
window.reqNotif=()=>Notif.request();
window.reqCam=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:true});s.getTracks().forEach(t=>t.stop());state.perms.camera=true;render()}catch{}};
window.goLogin=()=>{state.screen='login';render()};
window.doLogin=async()=>{
    const e=document.getElementById('email')?.value,p=document.getElementById('pwd')?.value;
    if(!e||!p)return U.toast('Faltan datos','error');
    state.loading=true;render();
    const{error}=await Cloud.login(e,p);
    state.loading=false;
    if(error)U.toast(error.message,'error');else{state.screen='app';render()}
};
window.offlineMode=()=>{currentUser={id:'local',email:'Local'};DB.set('user',currentUser);state.screen='app';render()};
window.logout=()=>Cloud.logout();
window.saveEdit=()=>{const f={nombre:document.getElementById('eNombre').value,dosis:document.getElementById('eDosis').value,frecuencia:parseInt(document.getElementById('eFrec').value)||8,hora_inicio:document.getElementById('eHora').value,notas:document.getElementById('eNotas').value};Act.update(state.selMed.id,f)};
window.saveNew=()=>{const f={nombre:document.getElementById('nNombre').value,dosis:document.getElementById('nDosis').value,frecuencia:parseInt(document.getElementById('nFrec').value)||8,horaInicio:document.getElementById('nHora').value,notas:document.getElementById('nNotas').value};Act.add(f);state.modal=null;U.toast('AÃ±adido')};

// Render
function render(){
    const $=document.getElementById('app');
    if(state.screen==='splash'){$.innerHTML=`<div class="h-screen bg-indigo-600 flex items-center justify-center text-white text-4xl">ğŸ’Š</div>`;return}
    if(state.screen==='login'){$.innerHTML=renderLogin();return}
    $.innerHTML=renderApp()
}
function renderLogin(){return`<div class="h-screen bg-indigo-600 flex flex-col justify-center p-8"><h1 class="text-white text-3xl font-bold mb-8 text-center">Mi MedicaciÃ³n</h1><input id="email" type="email" placeholder="Email" class="p-4 rounded-xl mb-4"><input id="pwd" type="password" placeholder="Pass" class="p-4 rounded-xl mb-4"><button onclick="doLogin()" class="bg-white text-indigo-600 p-4 rounded-xl font-bold">Entrar</button><button onclick="offlineMode()" class="mt-4 text-white">Modo Offline</button></div>`}
function renderApp(){
    const pend=state.meds.filter(m=>m.activo&&!U.takenToday(m.id)),comp=state.meds.filter(m=>m.activo&&U.takenToday(m.id));
    let c='';
    if(state.tab==='home')c=`<div class="bg-indigo-600 text-white p-6 rounded-b-3xl mb-4"><h1 class="text-2xl font-bold">Hoy</h1><p>${U.date()}</p></div><div class="px-4"><button onclick="openModal('camera')" class="w-full bg-indigo-100 text-indigo-600 p-4 rounded-xl font-bold mb-4 flex items-center justify-center gap-2">ğŸ“· Escanear Receta</button><button onclick="openModal('add')" class="w-full border-2 border-indigo-100 text-gray-600 p-4 rounded-xl font-bold mb-6">+ AÃ±adir Manual</button><h2 class="font-bold mb-2">Pendientes (${pend.length})</h2>${pend.map(m=>`<div class="bg-white p-4 rounded-xl shadow mb-2 flex justify-between items-center border-l-4 border-orange-400"><div><h3 class="font-bold">${m.nombre}</h3><p class="text-sm text-gray-500">${m.dosis} â€¢ ${m.proxima_toma}</p></div><button onclick="takeMed('${m.id}')" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-bold">Tomar</button></div>`).join('')}${pend.length===0?'<p class="text-gray-400 text-center">Todo listo por hoy ğŸ‰</p>':''}</div>`;
    else if(state.tab==='meds')c=`<div class="p-4"><h2 class="text-xl font-bold mb-4">Mis Medicamentos</h2>${state.meds.filter(m=>m.activo).map(m=>`<div class="bg-white p-4 rounded-xl shadow mb-3"><div class="flex justify-between"><div><h3 class="font-bold">${m.nombre}</h3><p class="text-sm text-gray-500">${m.dosis} â€¢ Cada ${m.frecuencia}h</p></div><button onclick="openModal('edit','${m.id}')">âœï¸</button></div></div>`).join('')}</div>`;
    else if(state.tab==='history')c=`<div class="p-4"><h2 class="text-xl font-bold mb-4">Historial</h2>${Act.filteredHist().map(h=>`<div class="bg-white p-3 rounded-xl shadow mb-2 flex items-center gap-3"><span class="${h.estado==='tomado'?'text-green-500':'text-red-500'} font-bold">${h.estado==='tomado'?'âœ“':'âœ—'}</span><div><p class="font-bold">${h.nombre}</p><p class="text-xs text-gray-400">${new Date(h.fecha).toLocaleString()}</p></div></div>`).join('')}</div>`;
    else if(state.tab==='profile')c=`<div class="p-8"><h2 class="text-xl font-bold mb-4">Perfil</h2><p class="mb-4">${currentUser?.email}</p><button onclick="logout()" class="text-red-500">Cerrar SesiÃ³n</button></div>`;
    
    return`<div class="h-screen flex flex-col bg-gray-50"><div class="flex-1 overflow-auto pb-20">${c}</div><div class="fixed bottom-0 w-full bg-white border-t flex justify-around p-3">${['home','meds','history','profile'].map(t=>`<button onclick="setTab('${t}')" class="text-2xl ${state.tab===t?'opacity-100':'opacity-50'}">${{home:'ğŸ ',meds:'ğŸ’Š',history:'ğŸ“‹',profile:'ğŸ‘¤'}[t]}</button>`).join('')}</div>${state.modal?renderModal():''}</div>`
}
function renderModal(){
    const m=state.selMed;
    if(state.modal==='camera')return`<div class="fixed inset-0 bg-black z-50 flex flex-col justify-center p-8 gap-4"><button onclick="closeModal()" class="text-white absolute top-4 right-4 text-2xl">âœ•</button><button onclick="captureRecipe()" class="bg-indigo-600 text-white p-6 rounded-2xl font-bold text-xl">ğŸ“¸ Hacer Foto</button><button onclick="scanRecipe()" class="bg-white text-gray-900 p-6 rounded-2xl font-bold text-xl">ğŸ–¼ï¸ GalerÃ­a</button></div>`;
    if(state.modal==='ocr-results')return`<div class="fixed inset-0 bg-white z-50 overflow-auto"><div class="p-4 border-b flex justify-between items-center"><h2 class="font-bold">Resultados</h2><button onclick="closeModal()">âœ•</button></div><div class="p-4">${state.pendingOCR.map(m=>`<div onclick="toggleOCR(${m.id})" class="p-4 border-2 rounded-xl mb-2 ${m.checked?'border-green-500 bg-green-50':'border-gray-200'}"><h3 class="font-bold">${m.nombre}</h3><p>${m.dosis} â€¢ ${m.frecuencia}h</p></div>`).join('')}<button onclick="confirmOCR()" class="w-full bg-green-500 text-white p-4 rounded-xl font-bold mt-4">Guardar Seleccionados</button></div></div>`;
    if(state.modal==='add')return`<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6"><h2 class="font-bold mb-4">AÃ±adir</h2><input id="nNombre" placeholder="Nombre" class="w-full p-2 border rounded mb-2"><input id="nDosis" placeholder="Dosis" class="w-full p-2 border rounded mb-2"><input id="nFrec" type="number" placeholder="Horas (8)" class="w-full p-2 border rounded mb-2"><input id="nHora" type="time" value="08:00" class="w-full p-2 border rounded mb-2"><input id="nNotas" placeholder="Notas" class="w-full p-2 border rounded mb-4"><div class="flex gap-2"><button onclick="closeModal()" class="flex-1 p-2 bg-gray-100 rounded">Cancelar</button><button onclick="saveNew()" class="flex-1 p-2 bg-green-500 text-white rounded">Guardar</button></div></div></div>`;
    return'';
}

init();
async function init(){await Cloud.init();DB.load();setTimeout(()=>{state.screen=currentUser?'app':'login';render()},1000)}

})();
</script>
</body>
</html>
